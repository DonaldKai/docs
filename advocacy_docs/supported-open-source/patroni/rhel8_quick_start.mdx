---
title: 'Quick start on RHEL 8'
description: "A walkthrough: setup a demo cluster using Patroni and etcd"
---


This walks you through the various steps to create an highly available **demo** cluster (using **PostgreSQL** version 14 on Rocky Linux 8) where the etcd hosts will be called **etcd1**, **etcd2** and **etcd3**, and the two PostgreSQL nodes in _Streaming Replication_ are **pg-patroni1** and **pg-patroni2**.

![Demo diagram](images/etcd-demo.png)

---

## Etcd

See [Etcd](etcd) to install and set up etcd.

## PostgreSQL

On both **pg-patroni1** and **pg-patroni2** hosts, install PostgreSQL:

```bash
$ sudo dnf install -y https://download.postgresql.org/pub/repos/yum/reporpms/EL-8-x86_64/pgdg-redhat-repo-latest.noarch.rpm
$ sudo dnf -qy module disable postgresql
$ sudo dnf install -y postgresql14-server postgresql14-contrib
$ sudo systemctl disable postgresql-14
```

Patroni will bootstrap (create) the initial PostgreSQL cluster and be in charge of starting the service, so be sure `systemctl` is disabled for the PostgreSQL service.

Don't forget to configure the firewall so the nodes accept connections to the PostgreSQL service:

```bash
$ sudo firewall-cmd --quiet --permanent --add-service=postgresql
$ sudo firewall-cmd --quiet --reload
```

## Watchdog

Patroni will be the component interacting with the watchdog device. Set the permissions of the software watchdog on both **pg-patroni1** and **pg-patroni2** hosts:

```bash
$ cat <<EOF | sudo tee /etc/udev/rules.d/99-watchdog.rules
KERNEL=="watchdog", OWNER="postgres", GROUP="postgres"
EOF
$ sudo sh -c 'echo "softdog" >> /etc/modules-load.d/softdog.conf'
$ sudo modprobe softdog
$ sudo chown postgres: /dev/watchdog
```

## Patroni

On both **pg-patroni1** and **pg-patroni2** hosts, install Patroni and its dependencies for etcd, following the steps in [Installing Patroni](installing).

Let us now define the Patroni configuration in `/etc/patroni.yml`:

```bash
$ CLUSTER_NAME="demo-cluster-1"
$ MY_NAME=$(hostname --short)
$ MY_IP=$(hostname -I | awk ' {print $1}')
$ cat <<EOF | sudo tee /etc/patroni.yml
scope: $CLUSTER_NAME
namespace: /db/
name: $MY_NAME

restapi:
  listen: "0.0.0.0:8008"
  connect_address: "$MY_IP:8008"
  authentication:
    username: patroni
    password: mySupeSecretPassword

etcd3:
    hosts:
    - etcd1:2379
    - etcd2:2379
    - etcd3:2379

bootstrap:
  dcs:
    ttl: 30
    loop_wait: 10
    retry_timeout: 10
    maximum_lag_on_failover: 1048576
    postgresql:
      use_pg_rewind: true
      use_slots: true
      parameters:
        archive_mode: "on"
        archive_command: "/bin/true"

  initdb:
  - encoding: UTF8
  - data-checksums
  - auth-local: peer
  - auth-host: scram-sha-256

  pg_hba:
  - host replication replicator 0.0.0.0/0 scram-sha-256
  - host all all 0.0.0.0/0 scram-sha-256

  # Some additional users which needs to be created after initializing new cluster
  users:
    admin:
      password: admin%
      options:
        - createrole
        - createdb

postgresql:
  listen: "0.0.0.0:5432"
  connect_address: "$MY_IP:5432"
  data_dir: /var/lib/pgsql/14/data
  bin_dir: /usr/pgsql-14/bin
  pgpass: /tmp/pgpass0
  authentication:
    replication:
      username: replicator
      password: confidential
    superuser:
      username: postgres
      password: my-super-password
    rewind:
      username: rewind_user
      password: rewind_password
  parameters:
    unix_socket_directories: '/var/run/postgresql,/tmp'

watchdog:
  mode: required
  device: /dev/watchdog
  safety_margin: 5

tags:
  nofailover: false
  noloadbalance: false
  clonefrom: false
  nosync: false
EOF
```

Except for `$MY_IP` and `$MY_NAME` which are related to the local host, the `patroni.yml` configuration should be the same on all Patroni nodes.

Depending on the Patroni installation source, create the [systemd file](https://github.com/zalando/patroni/blob/master/extras/startup-scripts/patroni.service) if not done during the installation and start the Patroni service:

```bash
$ cat <<EOF | sudo tee /etc/systemd/system/patroni.service
[Unit]
Description=Runners to orchestrate a high-availability Postgres
After=syslog.target network.target

[Service]
Type=simple
User=postgres
Group=postgres
EnvironmentFile=-/etc/patroni_env.conf
ExecStart=patroni /etc/patroni.yml
ExecReload=/bin/kill -s HUP \$MAINPID
KillMode=process
TimeoutSec=30
Restart=no

[Install]
WantedBy=multi-user.target
EOF

$ sudo systemctl daemon-reload
$ sudo systemctl enable patroni
$ sudo systemctl start patroni
```

First, start the Patroni service on **pg-patroni1** so it becomes the leader of our PostgreSQL cluster, and then start **pg-patroni2**.

To list the members of the cluster, use the `patronictl` command:

```bash
$ patronictl -c /etc/patroni.yml list
+ Cluster: demo-cluster-1 (7104275668989116902) ----+----+-----------+
| Member      | Host            | Role    | State   | TL | Lag in MB |
+-------------+-----------------+---------+---------+----+-----------+
| pg-patroni1 | 192.168.121.61  | Leader  | running |  1 |           |
| pg-patroni2 | 192.168.121.135 | Replica | running |  1 |         0 |
+-------------+-----------------+---------+---------+----+-----------+
```

The Patroni REST API is available on port `8008`. Don't forget to configure the firewall if needed:

```bash
$ sudo firewall-cmd --quiet --zone=public --add-port=8008/tcp --permanent
$ sudo firewall-cmd --quiet --reload
```

## HAProxy

Instead of connecting directly to the database server, it is possible to setup HAProxy so the application will be connecting to the proxy instead, which will then forward the request to PostgreSQL. By using HAproxy, it is also possible to route read-only requests to one or more replicas, for load balancing, by setting up a separate port for it (see configuration example below).

HAproxy can be installed as an independent server but it can also be installed on the application server or the database server itself.

For the purpose of this demo, let us install HAProxy on both **pg-patroni1** and **pg-patroni2** hosts:

```bash
$ sudo dnf install -y haproxy
$ sudo cp /etc/haproxy/haproxy.cfg /etc/haproxy/haproxy.cfg.bck
$ cat <<EOF | sudo tee /etc/haproxy/haproxy.cfg
global
    maxconn 100

defaults
    log    global
    mode    tcp
    retries 2
    timeout client 30m
    timeout connect 4s
    timeout server 30m
    timeout check 5s

listen stats
    mode http
    bind *:7000
    stats enable
    stats uri /

listen read-write
    bind *:5000
    option httpchk OPTIONS /read-write
    http-check expect status 200
    default-server inter 3s fall 3 rise 2 on-marked-down shutdown-sessions
    server pg-patroni1 pg-patroni1:5432 maxconn 100 check port 8008
    server pg-patroni2 pg-patroni2:5432 maxconn 100 check port 8008

listen read-only
    balance roundrobin
    bind *:5001
    option httpchk OPTIONS /replica
    http-check expect status 200
    default-server inter 3s fall 3 rise 2 on-marked-down shutdown-sessions
    server pg-patroni1 pg-patroni1:5432 maxconn 100 check port 8008
    server pg-patroni2 pg-patroni2:5432 maxconn 100 check port 8008
EOF

$ sudo setsebool -P haproxy_connect_any=1
$ sudo systemctl enable haproxy
$ sudo systemctl start haproxy
```

There are two sections: **read-write**, using port `5000`, and **read-only**, using port `5001`. All PostgreSQL hosts are included in both sections because they are both potential candidates to be either primary or standby. For HAproxy to know which role each host currently has, it will query the Patroni REST API:

```bash
$ curl -s http://pg-patroni1:8008
{
  "state": "running",
  "postmaster_start_time": "2022-06-01 14:17:57.445349+00:00",
  "role": "master",
  "server_version": 140003,
  "xlog": {
    "location": 50334688
  },
  "timeline": 1,
  "replication": [
    {
      "usename": "replicator",
      "application_name": "pg-patroni2",
      "client_addr": "192.168.121.135",
      "state": "streaming",
      "sync_state": "async",
      "sync_priority": 0
    }
  ],
  "dcs_last_seen": 1654095818,
  "database_system_identifier": "7104275668989116902",
  "patroni": {
    "version": "2.1.3",
    "scope": "demo-cluster-1"
  }
}
```

!!! Note
    By using the `/replica` option Patroni will only redirect to standby server. Use `/read-only` to also include the primary.


Don't forget to configure the firewall if needed:

```bash
$ sudo firewall-cmd --quiet --zone=public --add-port=7000/tcp --permanent
$ sudo firewall-cmd --quiet --zone=public --add-port=5000/tcp --permanent
$ sudo firewall-cmd --quiet --zone=public --add-port=5001/tcp --permanent
$ sudo firewall-cmd --quiet --reload
```

Both `5000` and `5001` ports can now be used to choose between read-write or read-only connection:

```bash
$ psql -U admin -d postgres -h pg-patroni1 -p 5000 -c "SELECT pg_is_in_recovery();"
 pg_is_in_recovery
-------------------
 f
(1 row)

$ psql -U admin -d postgres -h pg-patroni1 -p 5001 -c "SELECT pg_is_in_recovery();"
 pg_is_in_recovery
-------------------
 t
(1 row)
```
