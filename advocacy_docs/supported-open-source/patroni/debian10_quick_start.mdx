---
title: 'Quick start on Debian 10'
description: "A walkthrough: setup a demo cluster using Patroni and etcd"
---


This walks you through the various steps to create an highly available demo cluster (using EDB Postgres Advanced Server version 14 on Debian 10) where the etcd hosts will be called etcd1, etcd2 and etcd3, and the two EPAS nodes in _Streaming Replication_ are pg-patroni1 and pg-patroni2.

![Demo diagram](images/etcd-demo.png)

---

## Etcd

See [Etcd](etcd) to install and set up etcd.

## EDB Postgres Advanced Server

More information about installing EDB Postgres Advanced Server using the EDB repository can be found in [EDB docs](https://www.enterprisedb.com/docs/epas/latest/epas_inst_linux/installing_epas_using_edb_repository).

On both pg-patroni1 and pg-patroni2 hosts, install EPAS:

```bash
$ sudo apt-get install -y wget gnupg2 apt-transport-https
$ sudo sh -c 'echo "deb [arch=amd64] https://apt.enterprisedb.com/$(lsb_release -cs)-edb/ $(lsb_release -cs) main" > /etc/apt/sources.list.d/edb-$(lsb_release -cs).list'

#  Replace '<USERNAME>' and '<PASSWORD>' below with your username and password for the EDB repositories
$ sudo sh -c 'echo "machine apt.enterprisedb.com login <USERNAME> password <PASSWORD>" > /etc/apt/auth.conf.d/edb.conf'
$ wget -q -O - https://<USERNAME>:<PASSWORD>@apt.enterprisedb.com/edb-deb.gpg.key | sudo apt-key add -

$ sudo apt-get update
$ sudo apt-get -y install edb-as14-server
$ sudo systemctl disable edb-as@14-main.service
```

Patroni will bootstrap (create) the initial EPAS cluster and be in charge of starting the service, so be sure `systemctl` is disabled for the EPAS service.

Remove the EPAS cluster created during the installation:

```bash
$ sudo systemctl stop edb-as@14-main.service
$ sudo rm -fr /var/lib/edb-as/14/main
```

## Watchdog

Patroni will be the component interacting with the watchdog device. Set the permissions of the software watchdog on both pg-patroni1 and pg-patroni2 hosts:

```bash
$ cat <<EOF | sudo tee /etc/udev/rules.d/99-watchdog.rules
KERNEL=="watchdog", OWNER="enterprisedb", GROUP="enterprisedb"
EOF
$ sudo sh -c 'echo "softdog" >> /etc/modules-load.d/softdog.conf'
$ sudo modprobe softdog
$ sudo chown enterprisedb: /dev/watchdog
```

## Patroni

On both pg-patroni1 and pg-patroni2 hosts, install Patroni and its dependencies for etcd, following the steps in [Installing Patroni](installing/).

While EPAS has been installed from EDB repository, Patroni can be installed from the [PostgreSQL](https://www.postgresql.org/download/linux/ubuntu/) apt repository:

```bash
$ sudo sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list'
$ wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -
$ sudo apt-get update
$ sudo apt-get -y install patroni
```

Let us now define the Patroni configuration in `/etc/patroni.yml`:

```bash
$ CLUSTER_NAME="demo-cluster-1"
$ MY_NAME=$(hostname --short)
$ MY_IP=$(hostname -I | awk ' {print $1}')
$ cat <<EOF | sudo tee /etc/patroni.yml
scope: $CLUSTER_NAME
namespace: /db/
name: $MY_NAME

restapi:
  listen: "0.0.0.0:8008"
  connect_address: "$MY_IP:8008"
  authentication:
    username: patroni
    password: mySupeSecretPassword

etcd3:
    hosts:
    - etcd1:2379
    - etcd2:2379
    - etcd3:2379

bootstrap:
  dcs:
    ttl: 30
    loop_wait: 10
    retry_timeout: 10
    maximum_lag_on_failover: 1048576
    postgresql:
      use_pg_rewind: true
      use_slots: true
      parameters:
        archive_mode: "on"
        archive_command: "/bin/true"

  initdb:
  - encoding: UTF8
  - data-checksums
  - auth-local: peer
  - auth-host: scram-sha-256

  pg_hba:
  - host replication replicator 0.0.0.0/0 scram-sha-256
  - host all all 0.0.0.0/0 scram-sha-256

  # Some additional users which needs to be created after initializing new cluster
  users:
    admin:
      password: admin%
      options:
        - createrole
        - createdb

postgresql:
  listen: "0.0.0.0:5444"
  connect_address: "$MY_IP:5444"
  data_dir: "/var/lib/edb-as/14/main"
  bin_dir: "/usr/lib/edb-as/14/bin"
  pgpass: /tmp/pgpass0
  authentication:
    replication:
      username: replicator
      password: confidential
    superuser:
      username: enterprisedb
      password: my-super-password
    rewind:
      username: rewind_user
      password: rewind_password
  parameters:
    unix_socket_directories: "/var/run/edb-as,/tmp"

watchdog:
  mode: required
  device: /dev/watchdog
  safety_margin: 5

tags:
  nofailover: false
  noloadbalance: false
  clonefrom: false
  nosync: false
EOF
```

Except for `$MY_IP` and `$MY_NAME` which are related to the local host, the `patroni.yml` configuration should be the same on all Patroni nodes.

Patroni expects to find the `postgres` binary in the `bin_dir` location while the EPAS binary is called `edb-postgres`. Create a symbolic link to let Patroni find that binary:

```bash
$ sudo ln -s /usr/lib/edb-as/14/bin/edb-postgres /usr/lib/edb-as/14/bin/postgres
```

Depending on the Patroni installation source, create the [systemd file](https://github.com/zalando/patroni/blob/master/extras/startup-scripts/patroni.service) if not done during the installation and start the Patroni service:

```bash
$ cat <<EOF | sudo tee /etc/systemd/system/patroni.service
[Unit]
Description=Runners to orchestrate a high-availability Postgres
After=syslog.target network.target

[Service]
Type=simple
User=enterprisedb
Group=enterprisedb
EnvironmentFile=-/etc/patroni_env.conf
ExecStart=patroni /etc/patroni.yml
ExecReload=/bin/kill -s HUP \$MAINPID
KillMode=process
TimeoutSec=30
Restart=no

[Install]
WantedBy=multi-user.target
EOF

$ sudo systemctl daemon-reload
$ sudo systemctl enable patroni
$ sudo systemctl start patroni
```

First, start the Patroni service on pg-patroni1 so it becomes the leader of our PostgreSQL cluster, and then start pg-patroni2.

To list the members of the cluster, use the `patronictl` command:

```bash
$ patronictl -c /etc/patroni.yml list
+ Cluster: demo-cluster-1 (7114936110138668110) ----+----+-----------+
| Member      | Host            | Role    | State   | TL | Lag in MB |
+-------------+-----------------+---------+---------+----+-----------+
| pg-patroni1 | 192.168.121.105 | Leader  | running |  1 |           |
| pg-patroni2 | 192.168.121.229 | Replica | running |  1 |         0 |
+-------------+-----------------+---------+---------+----+-----------+
```

The Patroni REST API is available on port `8008`.

## HAProxy

For the purpose of this demo, let us install HAProxy on both pg-patroni1 and pg-patroni2 hosts:

```bash
$ sudo apt-get install -y haproxy
$ sudo cp /etc/haproxy/haproxy.cfg /etc/haproxy/haproxy.cfg.bck
$ cat <<EOF | sudo tee /etc/haproxy/haproxy.cfg
global
    maxconn 100

defaults
    log    global
    mode    tcp
    retries 2
    timeout client 30m
    timeout connect 4s
    timeout server 30m
    timeout check 5s

listen stats
    mode http
    bind *:7000
    stats enable
    stats uri /

listen read-write
    bind *:5000
    option httpchk OPTIONS /read-write
    http-check expect status 200
    default-server inter 3s fall 3 rise 2 on-marked-down shutdown-sessions
    server pg-patroni1 pg-patroni1:5444 maxconn 100 check port 8008
    server pg-patroni2 pg-patroni2:5444 maxconn 100 check port 8008

listen read-only
    balance roundrobin
    bind *:5001
    option httpchk OPTIONS /replica
    http-check expect status 200
    default-server inter 3s fall 3 rise 2 on-marked-down shutdown-sessions
    server pg-patroni1 pg-patroni1:5444 maxconn 100 check port 8008
    server pg-patroni2 pg-patroni2:5444 maxconn 100 check port 8008
EOF

$ sudo systemctl enable haproxy
$ sudo systemctl start haproxy
```

There are two sections: read-write, using port `5000`, and read-only, using port `5001`. All EPAS hosts are included in both sections because they are both potential candidates to be either primary or standby. For HAproxy to know which role each host currently has, it will query the Patroni REST API:

```bash
$ curl -s http://pg-patroni1:8008
{
  "state": "running",
  "postmaster_start_time": "2022-06-30 07:45:55.427895+00:00",
  "role": "master",
  "server_version": 140400,
  "xlog": {
    "location": 67108960
  },
  "timeline": 1,
  "replication": [
    {
      "usename": "replicator",
      "application_name": "pg-patroni2",
      "client_addr": "192.168.121.229",
      "state": "streaming",
      "sync_state": "async",
      "sync_priority": 0
    }
  ],
  "dcs_last_seen": 1656575356,
  "database_system_identifier": "7114936110138668110",
  "patroni": {
    "version": "2.1.3",
    "scope": "demo-cluster-1"
  }
}
```

!!! Note
    By using the `/replica` option Patroni will only redirect to standby server. Use `/read-only` to also include the primary.


Both `5000` and `5001` ports can now be used to choose between read-write or read-only connection:

```bash
$ psql -U admin -d postgres -h pg-patroni1 -p 5000 -c "SELECT pg_is_in_recovery();"
 pg_is_in_recovery
-------------------
 f
(1 row)

$ psql -U admin -d postgres -h pg-patroni1 -p 5001 -c "SELECT pg_is_in_recovery();"
 pg_is_in_recovery
-------------------
 t
(1 row)
```
